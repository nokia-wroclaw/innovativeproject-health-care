dist: xenial
language: generic

addons:
  apt:
    packages:
      - python3-pip
      - python3-setuptools

services:
  - postgresql
  - docker

before_install:
  - pip3 install --upgrade pip

install:
  - npm --prefix ./frontend install
  - pip3 install --user -r backend/requirements.txt

before_script:
  - cp config.py.sample ./backend/config.py
  - psql -c "CREATE USER healthcheck WITH PASSWORD 'healthcheck';" -U postgres
  - psql -c "CREATE DATABASE healthcheck;" -U postgres

script:
  - npm --prefix ./frontend test
  - python3 -m unittest discover -s ./backend/tests

before_deploy_develop:
  - docker login -u "$DOCKER_LOGIN" -p "$DOCKER_PASSWORD"
  - IMAGE_TAG=develop docker-compose -f build.yml build

deploy_develop:
  provider: script
  script: IMAGE_TAG=develop docker-compose -f build.yml push
  on:
    branch: develop

before_deploy_master:
  - docker login -u "$DOCKER_LOGIN" -p "$DOCKER_PASSWORD"
  - IMAGE_TAG=latest docker-compose -f build.yml build

deploy_master:
  provider: script
  script: IMAGE_TAG=latest docker-compose -f build.yml push
  on:
    branch: master
